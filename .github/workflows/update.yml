name: Update breadth data

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'    # every UTC midnight
  workflow_dispatch:      # allows â€œRun workflowâ€ button

jobs:
  update_csvs:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      # â”€â”€ 1) Start Binance-Proxy as a Docker container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Launch binance-proxy (Docker)
        run: |
          docker run -d --name binance-proxy \
            -p 127.0.0.1:8090:8090 \
            nightshift2k/binance-proxy:latest
      - name: Wait for proxy to be ready
        run: |
          for i in {1..10}; do
            if curl --fail http://127.0.0.1:8090/api/v3/exchangeInfo; then
              echo "âœ…  proxy is up!"
              break
            fi
            echo "â³ waiting for proxyâ€¦"
            sleep 1
          done

      # â”€â”€ 2) Install Node.js and your dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci --omit=dev

      # â”€â”€ 3) Run your three scripts, which all point at 127.0.0.1:8090 â”€
      - name: Run breadth & HH-LL scripts
        run: |
          node pct_index.js     # writes data/ema_breadth_pct.csv & data/ema_values.csv
          node hh_llindex.js    # writes data/hh_ll_net_90days.csv
          node final_index.js   # optional extra dump

      # â”€â”€ 4) Commit & push the new CSVs back to GitHub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit & push updated CSVs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add data/*.csv
          git diff --quiet && echo "ğŸ›‘ no changes to commit" || git commit -m "ğŸ“ˆ Update breadth CSVs $(date -u +'%Y-%m-%d')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
